<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resume Analyzer</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --brand:#4463ff;
      --brand-2:#5b8cff;
      --ink:#0f172a;
      --muted:#64748b;
      --bg:#f6f8ff;
      --card:#ffffffcc;
    }
    html, body { height:100%; }
    body {
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(214,240,233,0.9), transparent 70%),
        radial-gradient(1200px 800px at 85% 90%, rgba(231,225,249,0.9), transparent 70%),
        radial-gradient(1000px 700px at 80% 0%, rgba(223,233,255,0.9), transparent 80%),
        linear-gradient(135deg, #e6f4ef, #e9efff);
      background-attachment: fixed;
    }

    nav.navbar {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .navbar-brand {
      font-weight: 700;
      color: var(--brand);
    }

    .hero{ padding: 80px 0 24px; text-align:center; }
    .title{ font-weight: 800; font-size: clamp(1.8rem, 2.4vw + 1rem, 3rem); }
    .sub{ color: var(--muted); max-width: 880px; margin: 10px auto 0; }

    .wrap{ min-height: calc(100vh - 220px); display:flex; align-items:center; justify-content:center; padding: 24px; }
    .card-glass{
      width:100%; max-width: 1100px;
      border: 1px solid #e9eafe;
      border-radius: 22px;
      background: var(--card);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(17,24,39,.06), inset 0 1px 0 rgba(255,255,255,.5);
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      background: rgba(68, 99, 255, 0.1);
      border: 1px solid rgba(68, 99, 255, 0.3);
      border-radius: 999px;
      padding: 10px 22px;
      font-weight: 600;
      color: var(--brand);
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(68, 99, 255, 0.1);
    }

    .grid{ display:grid; gap:28px; grid-template-columns: 1.2fr .8fr; }
    @media (max-width: 992px){ .grid{ grid-template-columns: 1fr; } }

    .dropzone{
      border: 2px dashed #cfd8ff; border-radius:16px; padding: 22px; background:#fff;
      min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: .2s ease;
    }
    .dropzone.dragover{ border-color: var(--brand); box-shadow: 0 0 0 6px #e9edff; background: #f9fbff; }

    .file-list{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:12px; }
    .file-pill{
      display:inline-flex; align-items:center; gap:.5rem;
      background:#f1f4ff; color:#334155; border:1px solid #e2e8ff;
      padding: 6px 10px; border-radius: 999px; font-size: .9rem;
    }
    .file-pill .remove-btn{ border:none; background:transparent; color:#e11d48; cursor:pointer; font-size:1rem; }

    .btn-primary-soft{
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border: none; color: #fff; font-weight: 700;
      padding: 10px 24px; border-radius: 999px;
      box-shadow: 0 8px 20px rgba(68,99,255,.25);
      transition: transform .15s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn-primary-soft:hover{ transform: translateY(-2px); box-shadow: 0 12px 28px rgba(68,99,255,.32); }

    .feature{ display:flex; gap:12px; align-items:flex-start; padding:12px; border-radius:12px; }
    .feature i{ color: var(--brand); font-size: 1.2rem; background:#eef2ff; border:1px solid #dbe3ff; border-radius:10px; padding:8px; }

    .navbar .btn-outline-danger {
      border-width: 1.5px;
      font-weight: 600;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container-fluid px-4">
    <a class="navbar-brand fw-bold text-primary" href="#"><i class="bi bi-stars"></i> Resume Analyzer</a>
    <div class="collapse navbar-collapse justify-content-end">
      {% if session.get('user') %}
        <div class="d-flex align-items-center gap-3">
          <span class="fw-semibold fs-6">👋 Welcome, {{ session['user'] }}</span>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-danger rounded-pill px-3 fw-semibold">Logout</a>
        </div>
      {% else %}
        <ul class="navbar-nav">
          <li class="nav-item me-2">
            <a class="btn btn-outline-primary rounded-pill px-3" href="{{ url_for('login') }}">Sign In</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-primary rounded-pill px-3" href="{{ url_for('signup') }}">Sign Up</a>
          </li>
        </ul>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Hero Section -->
<section class="hero">
  <div class="badge-pill">
    <i class="bi bi-stars"></i> AI-Powered Resume Checker
  </div>
  <h1 class="title mt-3">Get a recruiter-style score in seconds</h1>
  <p class="sub">Paste your job description, drop in a few resumes, and get clean, ranked results with skill matching and a beautiful report.</p>
</section>

<div class="wrap">
  <div class="card-glass p-4 p-lg-5">
    <form id="analyzeForm" enctype="multipart/form-data" class="grid">
      <div>
        <label class="form-label fw-semibold">Job Description</label>
        <textarea id="job_description" name="job_description" class="form-control mb-3" rows="7"
          placeholder="Paste job description here..." required>{{ saved_form.job_description if saved_form }}</textarea>

        <label class="form-label fw-semibold">Upload Resumes (PDF)</label>
        <div id="drop" class="dropzone mb-2 text-center">
          <div class="mb-1"><i class="bi bi-cloud-arrow-up-fill" style="font-size:1.8rem;color:#4463ff;"></i></div>
          <div class="fw-semibold">Drag & drop PDFs here</div>
          <div class="muted small">or click to browse</div>
          <input id="fileInput" type="file" name="resumes" accept="application/pdf"
            multiple required class="form-control mt-3" style="display:none;">
          <div id="fileList" class="file-list"></div>
        </div>

        <div class="d-flex align-items-center gap-2 mt-3">
          <button type="button" id="analyzeBtn" class="btn-primary-soft">
            <i class="bi bi-rocket-takeoff-fill me-1"></i> Analyze
          </button>
        </div>
      </div>

      <div class="highlights">
        <div class="feature bg-white border mb-2 rounded-3 shadow-sm p-3">
          <i class="bi bi-graph-up-arrow"></i>
          <div><div class="fw-bold">Smart matching</div><div class="muted small">Semantic keyword scoring & JD alignment.</div></div>
        </div>
        <div class="feature bg-white border mb-2 rounded-3 shadow-sm p-3">
          <i class="bi bi-list-check"></i>
          <div><div class="fw-bold">Ranked shortlist</div><div class="muted small">Clear, comparable scores for each resume.</div></div>
        </div>
        <div class="feature bg-white border mb-2 rounded-3 shadow-sm p-3">
          <i class="bi bi-shield-lock"></i>
          <div><div class="fw-bold">Private by design</div><div class="muted small">Files never leave the server.</div></div>
        </div>
        <div class="feature bg-white border rounded-3 shadow-sm p-3">
          <i class="bi bi-lightning-charge"></i>
          <div><div class="fw-bold">Fast & simple</div><div class="muted small">Drop, analyze, and export in one minute.</div></div>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h5 class="fw-bold mb-3">Please log in or sign up to continue</h5>
      <div class="d-flex justify-content-center gap-3">
        <a href="{{ url_for('login') }}" class="btn btn-primary rounded-pill px-4">Sign In</a>
        <a href="{{ url_for('signup') }}" class="btn btn-outline-primary rounded-pill px-4">Sign Up</a>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const drop = document.getElementById('drop');
const input = document.getElementById('fileInput');
const list = document.getElementById('fileList');
const analyzeBtn = document.getElementById('analyzeBtn');
let filesArray = [];

drop.addEventListener('click', () => input.click());
drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
input.addEventListener('change', () => handleFiles(input.files));

function handleFiles(files) {
  filesArray = [...filesArray, ...files];
  const dataTransfer = new DataTransfer();
  filesArray.forEach(f => dataTransfer.items.add(f));
  input.files = dataTransfer.files;
  renderFiles();
}

function renderFiles() {
  list.innerHTML = '';
  filesArray.forEach((f, i) => {
    const pill = document.createElement('span');
    pill.className = 'file-pill';
    pill.innerHTML = `<i class="bi bi-file-earmark-pdf"></i> ${f.name} <button type="button" class="remove-btn" data-index="${i}">&times;</button>`;
    list.appendChild(pill);
  });
  list.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      const idx = e.target.dataset.index;
      filesArray.splice(idx, 1);
      renderFiles();
    });
  });
}

// ✅ Robust Analyze Click Logic
analyzeBtn.addEventListener('click', async () => {
  try {
    console.log("🚀 Analyze clicked");
    const form = document.getElementById('analyzeForm');
    const formData = new FormData(form);
    const response = await fetch('/analyze', { method: 'POST', body: formData });
    console.log("📦 Response:", response);

    const text = await response.text();
    console.log("🧾 Raw:", text);

    let result;
    try { result = JSON.parse(text); } 
    catch { console.error("❌ Not valid JSON."); alert("Unexpected server response."); return; }

    console.log("✅ Parsed:", result);

    if (result.status === 'login_required') {
      await fetch('/store_form', { method: 'POST', body: formData });
      const modal = new bootstrap.Modal(document.getElementById('loginModal'));
      modal.show();
    } 
    else if (result.status === 'success' && result.redirect) {
      console.log("➡️ Redirecting to:", result.redirect);
      window.location.href = result.redirect;
    } 
    else if (result.status === 'error') {
      alert(result.message);
      console.error(result.message);
    }
  } catch (err) {
    console.error("❌ Analyze error:", err);
    alert("An error occurred. Check console logs.");
  }
});
</script>
</body>
</html>
